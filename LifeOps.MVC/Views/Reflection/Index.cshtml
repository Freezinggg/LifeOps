@{
    ViewData["Title"] = "All Reflection";
}

<h2>All Reflection</h2>

<div style="margin-bottom: 20px;">
    <button class="btn btn-success" onclick="openCreateModal()">+ Create Reflection</button>
</div>

<table class="table table-striped" id="reflectionTable">
    <thead>
        <tr>
            <th>Date</th>
            <th>Mood</th>
            <th>Energy Level</th>
            <th>Note</th>
        </tr>
    </thead>
    <tbody id="reflectionsBody">
        <tr>
            <td colspan="7">Loading reflection...</td>
        </tr>
    </tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="reflectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Reflection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="modalBody">
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadReflections();
    });

    function openCreateModal() {
    document.getElementById("modalTitle").innerText = "Create Reflection";

    fetch("/Reflection/CreatePartial")
        .then(res => res.text())
        .then(html => {
            document.getElementById("modalBody").innerHTML = html;

            attachEventFormListener();

            new bootstrap.Modal(document.getElementById("reflectionModal")).show();
        });
    }

    function openEditModal(reflectionId) {
        document.getElementById("modalTitle").innerText = "Edit Reflection";

        fetch(`/Reflection/EditPartial/${reflectionId}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById("modalBody").innerHTML = html;

                attachEventFormListener();

                new bootstrap.Modal(document.getElementById("reflectionModal")).show();
            });
    }

    async function loadReflections() {
        const tableBody = document.getElementById("reflectionsBody");

        try {
            const response = await fetch("/Reflection/GetReflections");

            if (!response.ok) {
                tableBody.innerHTML = `
                    <tr><td colspan="7">Failed to load reflections (Error ${response.status})</td></tr>
                `;
                return;
            }

            const result = await response.json();

            console.log("API result:", result);

            const reflections = Array.isArray(result)
                ? result
                : result.data ?? result.reflections ?? [];


            if (!reflections || reflections.length === 0) {
                tableBody.innerHTML = `
                    <tr><td colspan="7">No reflections found.</td></tr>
                `;
                return;
            }

            tableBody.innerHTML = "";

            reflections.forEach(rf => {
                //<td>${formatDate(rf.date)}</td>
                const row = `
                    <tr>
                        <td>${rf.date}</td>
                        <td>${rf.mood}</td>
                        <td>${rf.energyLevel}</td>
                        <td>${rf.note}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openEditModal('${rf.id}')">Edit</button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteReflection('${rf.id}')">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

        } catch (error) {
            console.error("Error loading reflections:", error);
            tableBody.innerHTML = `
                <tr><td colspan="7">Unexpected error while loading reflections.</td></tr>
            `;
        }
    }

    // function formatDate(dateStr) {
    //     const date = new Date(dateStr);
    //     return date.toLocaleString();
    // }

    function attachEventFormListener() {
        const form = document.getElementById("reflectionForm");
        if (!form) {
            
            return;
        }


        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            console.log("submit fired");

            const payload = {
                id: document.getElementById('Id').value || null,
                date: document.getElementById('Date').value,
                mood: document.getElementById('Mood').value,
                energyLevel: document.getElementById('EnergyLevel').value,
                note: document.getElementById('Note').value,
            };

            
            const isUpdate = payload.id && payload.id !== "";
            const url = isUpdate ? '/Reflection/Update/' + payload.id : '/Reflection/Create';

            const response = await fetch(url, {
                method: isUpdate ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                alert('Saved successfully!');
                setTimeout(() => location.reload(), 500);
            } else {
                alert(result.message);
            }
        });
    }

    async function deleteReflection(id) {
        if (!confirm("Are you sure you want to delete this reflection??")) return;

        const response = await fetch(`/Reflection/Delete/${id}`, {
            method: "DELETE"
        });

        const result = await response.json();

        if (result.success) {
            alert("Deleted successfully!");
            loadReflections();
        } else {
            alert(result.message || "Delete failed");
        }
    }


</script>
